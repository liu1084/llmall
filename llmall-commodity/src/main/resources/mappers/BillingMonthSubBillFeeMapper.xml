<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.g2link.web.stream.model.mapper.BillingMonthSubBillFeeMapper">
    <resultMap id="BaseResultMap" type="cn.g2link.bms.common.model.entity.bill.BillingMonthSubBillFee">
        <id column="id" jdbcType="BIGINT" property="id" />
        <result column="warehouse_code" jdbcType="VARCHAR" property="warehouseCode" />
        <result column="warehouse_name" jdbcType="VARCHAR" property="warehouseName" />
        <result column="owner_code" jdbcType="VARCHAR" property="ownerCode" />
        <result column="owner_name" jdbcType="VARCHAR" property="ownerName" />
        <result column="bill_time" jdbcType="TIMESTAMP" property="billTime" />
        <result column="entry_fee" jdbcType="DECIMAL" property="entryFee" />
        <result column="out_fee" jdbcType="DECIMAL" property="outFee" />
        <result column="keep_fee" jdbcType="DECIMAL" property="keepFee" />
        <result column="service_fee" jdbcType="DECIMAL" property="serviceFee" />
        <result column="total_fee" jdbcType="DECIMAL" property="totalFee" />
    </resultMap>
    
    <select id="countMonthBillFee" resultType="int">
        SELECT COUNT(1) as count
        FROM billing_month_sub_bill_fee t1
        WHERE 1=1
        AND t1.warehouse_code = #{warehouseCode}
        AND t1.owner_code = #{ownerCode}
        AND DATE_FORMAT(t1.bill_time, '%Y-%m') = DATE_FORMAT(FROM_UNIXTIME(#{billTime}/1000), '%Y-%m')
    </select>

    <insert id="addMonthBillFee" parameterType="BillingMonthSubBillFee">
        INSERT INTO billing_month_sub_bill_fee(
            warehouse_code, warehouse_name,
            owner_code, owner_name,
            bill_time, entry_fee,
            out_fee, keep_fee,
            service_fee, total_fee
        )
        VALUES (
            #{warehouseCode, jdbcType=VARCHAR}, #{warehouseName, jdbcType=VARCHAR},
            #{ownerCode, jdbcType=VARCHAR}, #{ownerName, jdbcType=VARCHAR},
            FROM_UNIXTIME(#{billTime,jdbcType=TIMESTAMP}/1000), #{entryFee, jdbcType=DECIMAL},
            #{outFee, jdbcType=DECIMAL}, #{keepFee, jdbcType=DECIMAL},
            #{serviceFee, jdbcType=DECIMAL}, #{totalFee, jdbcType=DECIMAL}
        )
    </insert>

    <update id="updateMonthBillFee" parameterType="BillingMonthSubBillFee">
        UPDATE billing_month_sub_bill_fee AS t1
        SET t1.entry_fee = #{entryFee, jdbcType=DECIMAL},
            t1.out_fee = #{outFee, jdbcType=DECIMAL},
            t1.keep_fee = #{keepFee, jdbcType=DECIMAL},
            t1.service_fee = #{serviceFee, jdbcType=DECIMAL},
            t1.total_fee = #{totalFee, jdbcType=DECIMAL},
            t1.update_time = CURRENT_TIMESTAMP
        WHERE 1=1
        AND t1.warehouse_code = #{warehouseCode}
        AND t1.owner_code = #{ownerCode}
        AND DATE_FORMAT(t1.bill_time, '%Y-%m') = DATE_FORMAT(FROM_UNIXTIME(#{billTime}/1000), '%Y-%m')
    </update>
</mapper>